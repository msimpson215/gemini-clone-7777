<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Minimal VoxTalk (Miracle Files)</title>
  <!-- Link to the CSS file -->
  <link rel="stylesheet" href="miracle-button.css">
</head>
<body>
  <!-- ChatGPT-style voice button -->
  <button id="startBtn" class="voice-button idle">ðŸŽ¤</button>

  <!-- Remote audio element -->
  <audio id="remote" autoplay playsinline></audio>

  <script>
    const startBtn = document.getElementById("startBtn");
    const rtAudio = document.getElementById("remote");

    async function init() {
      // disable button to prevent double-click
      startBtn.disabled = true;
      startBtn.className = "voice-button thinking";

      // Request session from server.js
      const s = await fetch("/session", { method: "POST" });
      const { client_secret, model, voice } = await s.json();

      // WebRTC connection
      const pc = new RTCPeerConnection();
      pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

      // Data channel (send transcripts/instructions if needed)
      const dc = pc.createDataChannel("oai-events");

      // Offer â†’ OpenAI
      const offer = await pc.createOffer({ offerToReceiveAudio: true });
      await pc.setLocalDescription(offer);
      const r = await fetch(`https://api.openai.com/v1/realtime?model=${model}&voice=${voice}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${client_secret.value}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });
      const answer = { type: "answer", sdp: await r.text() };
      await pc.setRemoteDescription(answer);

      // Mic input â†’ send to OpenAI
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const micTrack = stream.getTracks()[0];
      pc.addTrack(micTrack, stream);

      // Debug log when data channel opens
      dc.onopen = () => {
        console.log("Data channel open, ready for instructions");
        startBtn.className = "voice-button talking"; // animate as "talking"
      };

      // When mic stops â†’ back to idle
      micTrack.onended = () => {
        startBtn.className = "voice-button idle";
      };
    }

    startBtn.onclick = init;
  </script>
</body>
</html>
