<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Minimal VoxTalk (OpenAI - Nova)</title>
</head>
<body>
  <button id="startBtn">▶ Start Talking</button>
  <audio id="remote" autoplay playsinline></audio>

<script>
const startBtn = document.getElementById("startBtn");
const rtAudio = document.getElementById("remote");

async function init() {
  startBtn.disabled = true;

  // Step 1: ask our server for a new OpenAI session
  const s = await fetch("/session", { method: "POST" });
  const { client_secret, model, voice } = await s.json();

  // Step 2: create a WebRTC PeerConnection
  const pc = new RTCPeerConnection();
  pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

  // Data channel to send messages/instructions to OpenAI
  const dc = pc.createDataChannel("oai-events");
  dc.onopen = () => console.log("Data channel open");

  // Step 3: create an offer for audio back
  const offer = await pc.createOffer({ offerToReceiveAudio: true });
  await pc.setLocalDescription(offer);

  // Step 4: send offer to OpenAI Realtime API
  const r = await fetch(`https://api.openai.com/v1/realtime?model=${model}&voice=${voice}`, {
    method: "POST",
    headers: { 
      Authorization: `Bearer ${client_secret.value}`,
      "Content-Type": "application/sdp"
    },
    body: offer.sdp
  });
  const answer = { type: "answer", sdp: await r.text() };
  await pc.setRemoteDescription(answer);

  // Step 5: get mic input → send directly to OpenAI
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  stream.getTracks().forEach(track => pc.addTrack(track, stream));
}

startBtn.onclick = init;
</script>
</body>
</html>
