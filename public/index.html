<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Minimal VoxTalk (Miracle Files)</title>
  <link rel="stylesheet" href="miracle-button.css">
</head>
<body>
  <!-- Chat-style button -->
  <button id="startBtn" class="voice-button idle">Start</button>

  <!-- Remote audio output -->
  <audio id="remote" autoplay playsinline></audio>

  <script>
    const startBtn = document.getElementById("startBtn");
    const rtAudio = document.getElementById("remote");

    let pc, micStream, micTrack, active = false;

    async function startSession() {
      active = true;
      startBtn.textContent = "Stop";
      startBtn.className = "voice-button talking";

      // Request session from server.js
      const s = await fetch("/session", { method: "POST" });
      const { client_secret, model, voice } = await s.json();

      // WebRTC connection
      pc = new RTCPeerConnection();
      pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

      // Data channel
      const dc = pc.createDataChannel("oai-events");

      // Offer â†’ OpenAI
      const offer = await pc.createOffer({ offerToReceiveAudio: true });
      await pc.setLocalDescription(offer);
      const r = await fetch(
        `https://api.openai.com/v1/realtime?model=${model}&voice=${voice}`,
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${client_secret.value}`,
            "Content-Type": "application/sdp"
          },
          body: offer.sdp
        }
      );
      const answer = { type: "answer", sdp: await r.text() };
      await pc.setRemoteDescription(answer);

      // Mic input
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micTrack = micStream.getTracks()[0];
      pc.addTrack(micTrack, micStream);

      dc.onopen = () => console.log("Data channel open");
    }

    function stopSession() {
      active = false;
      startBtn.textContent = "Start";
      startBtn.className = "voice-button idle";

      // Kill mic
      if (micTrack) micTrack.stop();
      if (micStream) micStream.getTracks().forEach(t => t.stop());

      // Kill peer connection
      if (pc) pc.close();

      // ðŸš¨ Force remote audio to silence immediately
      rtAudio.srcObject = new MediaStream();
      rtAudio.pause();
      rtAudio.currentTime = 0;
    }

    startBtn.onclick = () => {
      if (!active) {
        startSession();
      } else {
        stopSession();
      }
    };
  </script>
</body>
</html>
