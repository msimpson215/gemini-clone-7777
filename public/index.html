<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Minimal VoxTalk (Miracle Files)</title>
  <link rel="stylesheet" href="miracle-button.css">
</head>
<body>
  <button id="startBtn" class="voice-button idle">Start</button>
  <audio id="remote" autoplay playsinline></audio>

  <script>
    const startBtn = document.getElementById("startBtn");
    const rtAudio = document.getElementById("remote");
    let pc, micStream, micTrack, active = false;

    async function startSession() {
      startBtn.disabled = true;
      startBtn.className = "voice-button talking";
      active = true;

      const s = await fetch("/session", { method: "POST" });
      const { client_secret, model, voice } = await s.json();

      pc = new RTCPeerConnection();
      pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

      const dc = pc.createDataChannel("oai-events");

      const offer = await pc.createOffer({ offerToReceiveAudio: true });
      await pc.setLocalDescription(offer);
      const r = await fetch(`https://api.openai.com/v1/realtime?model=${model}&voice=${voice}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${client_secret.value}`, "Content-Type": "application/sdp" },
        body: offer.sdp
      });
      const answer = { type: "answer", sdp: await r.text() };
      await pc.setRemoteDescription(answer);

      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micTrack = micStream.getTracks()[0];
      pc.addTrack(micTrack, micStream);

      dc.onopen = () => console.log("Data channel open, ready");
      startBtn.disabled = false;
    }

    function stopSession() {
      startBtn.textContent = "Start";
      startBtn.className = "voice-button idle";
      active = false;

      // Kill mic
      if (micTrack) micTrack.stop();
      if (micStream) micStream.getTracks().forEach(t => t.stop());

      // Kill peer connection
      if (pc) pc.close();

      // Kill remote audio instantly
      rtAudio.srcObject = null;
      rtAudio.pause();
      rtAudio.currentTime = 0;
    }

    startBtn.onclick = async () => {
      if (!active) {
        startBtn.textContent = "Stop";
        await startSession();
      } else {
        stopSession();
      }
    };
  </script>
</body>
</html>
