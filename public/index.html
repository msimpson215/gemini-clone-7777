<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>VoxTalk (Miracle Files)</title>
  <!-- Link to button styles -->
  <link rel="stylesheet" href="miracle-button.css">
</head>
<body>
  <!-- ChatGPT-style voice button -->
  <button id="voiceBtn" class="voice-button idle">Start</button>

  <!-- Remote audio -->
  <audio id="remote" autoplay playsinline></audio>

  <script>
    const btn = document.getElementById("voiceBtn");
    const rtAudio = document.getElementById("remote");

    let pc, dc, micStream, micTrack, active = false;

    async function startSession() {
      btn.textContent = "Stop";
      btn.className = "voice-button talking";
      active = true;

      // Request session from server.js
      const s = await fetch("/session", { method: "POST" });
      const { client_secret, model, voice } = await s.json();

      // WebRTC connection
      pc = new RTCPeerConnection();
      pc.ontrack = (ev) => { rtAudio.srcObject = ev.streams[0]; };

      // Data channel
      dc = pc.createDataChannel("oai-events");

      // Offer â†’ OpenAI
      const offer = await pc.createOffer({ offerToReceiveAudio: true });
      await pc.setLocalDescription(offer);
      const r = await fetch(`https://api.openai.com/v1/realtime?model=${model}&voice=${voice}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${client_secret.value}`,
          "Content-Type": "application/sdp"
        },
        body: offer.sdp
      });
      const answer = { type: "answer", sdp: await r.text() };
      await pc.setRemoteDescription(answer);

      // Mic input
      micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      micTrack = micStream.getTracks()[0];
      pc.addTrack(micTrack, micStream);

      dc.onopen = () => console.log("Data channel open");
    }

    function stopSession() {
      btn.textContent = "Start";
      btn.className = "voice-button idle";
      active = false;

      // Kill mic
      if (micTrack) micTrack.stop();
      if (micStream) micStream.getTracks().forEach(t => t.stop());

      // Kill peer connection
      if (pc) pc.close();

      // Kill remote audio
      rtAudio.srcObject = null;
    }

    btn.onclick = async () => {
      if (!active) {
        await startSession();
      } else {
        stopSession();
      }
    };
  </script>
</body>
</html>
